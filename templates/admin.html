<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DWC Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f5f5f5; }
    h1 { margin-bottom: 12px; }
    #wsStatus { margin-bottom: 10px; font-size: 13px; color: #333; }
    #panes { display: flex; flex-wrap: wrap; gap: 16px; }
    #convos, #escalated, #history { flex: 1; min-width: 250px; border: 1px solid #ddd; padding: 8px; border-radius: 8px; background: #fff; }
    .convo { border: 1px solid #ccc; padding: 6px; margin: 6px 0; border-radius: 6px; cursor: pointer; background: #f9f9f9; }
    .convo.escalated { background: #fee2e2; border-color: #f87171; }
    #chatbox { margin-top: 16px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; display: none; background: #fff; }
    #msgs { height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 6px; margin-bottom: 8px; background: #fafafa; }
    .msg { margin-bottom: 6px; }
    .msg .meta { font-size: 12px; color: #666; margin-bottom: 2px; }
    .bubble { display: inline-block; padding: 6px 10px; border-radius: 10px; background: #eef; }
    .msg.staff .bubble { background: #e7f9e7; }
    #typingIndicator { display:none; font-style: italic; color: #888; margin: 6px 0; }
  </style>
</head>
<body>
  <h1>DWC Admin Dashboard</h1>
  <div id="wsStatus">[admin] not connected</div>

  <div id="panes">
    <div id="convos"><h2>Open</h2></div>
    <div id="escalated"><h2>Escalated</h2></div>
    <div id="history"><h2>History</h2></div>
  </div>

  <div id="chatbox">
    <h2>Conversation: <span id="cid"></span> <small id="cchan"></small></h2>
    <div id="msgs"></div>
    <div id="typingIndicator">User is typing<span id="typingDots">.</span></div>
    <input id="reply" placeholder="Type reply..." style="width:70%;padding:6px;" />
    <button id="sendBtn">Send</button>
  </div>

  <script>
  console.log("[admin] script loaded");
  let current = null;
  let wsAdmin;

  async function loadConvos(){
    try{
      const res = await fetch('/admin/api/convos');
      const data = await res.json();
      const div = document.getElementById('convos');
      div.innerHTML = '<h2>Open</h2>';
      (data.conversations||[]).forEach(c=>{
        const el=document.createElement('div');
        el.className='convo';
        el.textContent=`${c.user_id} (${c.channel})`;
        el.onclick=()=>openConvo(c.channel,c.user_id);
        div.appendChild(el);
      });
    }catch(e){console.error(e);}
  }

  async function loadEscalated(){
    try{
      const res = await fetch('/admin/api/escalated');
      const data = await res.json();
      const div = document.getElementById('escalated');
      div.innerHTML = '<h2>Escalated</h2>';
      (data.conversations||[]).forEach(c=>{
        const el=document.createElement('div');
        el.className='convo escalated';
        el.textContent=`${c.user_id} (${c.channel})`;
        el.onclick=()=>openConvo(c.channel,c.user_id);
        div.appendChild(el);
      });
    }catch(e){console.error(e);}
  }

  async function loadHistory(){
    try{
      const res = await fetch('/admin/api/history');
      const data = await res.json();
      const div = document.getElementById('history');
      div.innerHTML = '<h2>History</h2>';
      (data.conversations||[]).forEach(c=>{
        const el=document.createElement('div');
        el.className='convo';
        el.textContent=`${c.user_id} (${c.channel})`;
        el.onclick=()=>openConvo(c.channel,c.user_id);
        div.appendChild(el);
      });
    }catch(e){console.error(e);}
  }

  async function openConvo(channel,user_id){
    current = {channel,user_id};
    document.getElementById('cid').textContent = user_id;
    document.getElementById('cchan').textContent = '('+channel+')';
    document.getElementById('chatbox').style.display = 'block';

    const res = await fetch(`/admin/api/messages/${channel}/${user_id}`);
    if (!res.ok) { console.error("[admin] fetch messages failed", res.status); return; }
    const data = await res.json();
    const msgs = document.getElementById('msgs');
    msgs.innerHTML = '';
    (data.messages || []).forEach(m=>{
      const row = document.createElement('div');
      row.className = 'msg ' + m.sender;
      const meta = document.createElement('div'); meta.className = 'meta';
      const ts = m.ts ? new Date(m.ts).toLocaleString() : "";
      meta.textContent = `${m.sender}${ts ? " — " + ts : ""}`;
      const bubble = document.createElement('div'); bubble.className = 'bubble';
      bubble.textContent = m.text;
      row.appendChild(meta); row.appendChild(bubble);
      msgs.appendChild(row);
    });
    msgs.scrollTop = msgs.scrollHeight;
  }

  async function send(){
    if(!current) return;
    const text = document.getElementById('reply').value.trim();
    if(!text) return;
    document.getElementById('reply').value='';
    await fetch('/admin/api/send',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...current,text}) });
  }

  document.getElementById('sendBtn').addEventListener('click', send);

  // ============ WebSocket ============
  function connectAdminWS(){
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const url = `${proto}://${location.host}/admin-ws`;
    console.log("[admin] connecting WS", url);
    wsAdmin = new WebSocket(url);

    wsAdmin.onopen = () => {
      console.log("[admin] WS connected");
      document.getElementById('wsStatus').textContent = "[admin] WS connected";
      loadConvos(); loadEscalated(); loadHistory();
    };

    wsAdmin.onerror = (e) => {
      console.error("[admin] WS error", e);
      document.getElementById('wsStatus').textContent = "[admin] WS error";
    };

    wsAdmin.onclose = () => {
      console.warn("[admin] WS closed, retrying...");
      document.getElementById('wsStatus').textContent = "[admin] WS closed";
      setTimeout(connectAdminWS, 3000);
    };

wsAdmin.onmessage = (event) => {
  try {
    const data = JSON.parse(event.data);
    console.log("[admin] WS message received:", data);

    // If no convo is open, auto-open
    if (!current) {
      openConvo(data.channel, data.user_id);
    }

    // If this message belongs to the open conversation, append it
    if (current && current.user_id === data.user_id && current.channel === data.channel) {
      if (data.type === "typing") {
        showTyping(true);
      } else if (data.type === "stop_typing") {
        showTyping(false);
      } else {
        appendIncomingMessage(data);
      }
    }

    // Optionally refresh convo list preview
// refreshConvoPreview(data.user_id, data.channel, data.text, data.ts);


  } catch (err) {
    console.error("Failed to parse WS message", err, event.data);
  }
};

// helper function to add message to UI
function appendIncomingMessage(data) {
  const msgs = document.getElementById("msgs");
  const row = document.createElement("div");
  row.className = "msg " + (data.sender || "system");

  const meta = document.createElement("div");
  meta.className = "meta";
  const ts = data.ts ? new Date(data.ts).toLocaleString() : "";
  meta.textContent = `${data.sender || "system"}${ts ? " — " + ts : ""}`;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = data.text;

  row.appendChild(meta);
  row.appendChild(bubble);
  msgs.appendChild(row);
  msgs.scrollTop = msgs.scrollHeight;
  showTyping(false);
}

// --- Typing indicator helpers ---
let typingUiTimer = null, typingAutoHideTimer = null;
function showTyping(show){
  const ind=document.getElementById('typingIndicator');
  const dots=document.getElementById('typingDots');
  if(!ind||!dots) return;
  if(show){
    ind.style.display='block';
    if(typingUiTimer) clearInterval(typingUiTimer);
    let n=1;
    typingUiTimer=setInterval(()=>{
      n=(n%3)+1;
      dots.textContent='.'.repeat(n);
    },500);
    if(typingAutoHideTimer) clearTimeout(typingAutoHideTimer);
    typingAutoHideTimer=setTimeout(()=>showTyping(false),3000);
  } else {
    ind.style.display='none';
    if(typingUiTimer){ clearInterval(typingUiTimer); typingUiTimer=null; }
    if(typingAutoHideTimer){ clearTimeout(typingAutoHideTimer); typingAutoHideTimer=null; }
  }
}
}
// Kick off the WebSocket connection on page load
window.addEventListener("load", () => {
  connectAdminWS();
});
</script>
</body>
</html>
