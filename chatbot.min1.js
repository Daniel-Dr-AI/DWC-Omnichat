
document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("div");e.innerHTML='<div id="chat-toggle">💬</div><div id="chat-box" style="display:none; flex-direction:column;"><div id="messages" style="flex:1; overflow-y:auto; padding:8px;"></div><div id="typingIndicator" style="display:none; padding:4px; font-style:italic; color:gray;">Admin is typing<span id="typingDots">.</span></div><div id="input-box" style="display:flex; gap:4px; padding:8px;"><input id="msgInput" type="text" placeholder="Type a message..." style="flex:1;" /><button id="sendBtn">Send</button></div></div>',document.body.appendChild(e);const t=document.getElementById("chat-toggle"),n=document.getElementById("chat-box"),s=document.getElementById("msgInput"),o=document.getElementById("sendBtn"),a=document.getElementById("messages"),d=document.getElementById("typingIndicator"),i=document.getElementById("typingDots"),r="https://dwc-omnichat.onrender.com";let c=localStorage.getItem("dwc_user_id");c||(c="visitor-"+Math.floor(1e4*Math.random()),localStorage.setItem("dwc_user_id",c));let l,m,u,p;r.replace("https","wss")+"/ws/"+c;function y(e,t,n="system"){const s=document.createElement("div");s.className=n,s.innerHTML="<strong>"+e+":</strong> "+t,a.appendChild(s),a.scrollTop=a.scrollHeight}function h(e){d&&i&&(e?(d.style.display="block",u&&(clearInterval(u),u=null),m=1,u=setInterval(()=>{m=(m%3)+1,i.textContent=".".repeat(m)},500),p&&clearTimeout(p),p=setTimeout(()=>h(!1),3e3)):(d.style.display="none",u&&(clearInterval(u),u=null),i.textContent="."))}function C(){const e=r.replace("https","wss")+"/ws/"+c;console.log("[chatbot] Connecting to",e),l=new WebSocket(e),l.onopen=()=>y("System","Connected to chat.","system"),l.onmessage=t=>{try{const e=JSON.parse(t.data);console.log("[chatbot] WS message received:",e.type,e.sender,e),e.type==="typing"?h(!0):e.type==="stop_typing"?h(!1):y(e.sender||"Bot",e.text,"bot")}catch{y("System","⚠️ Invalid server message","system")}},l.onclose=()=>{y("System","Connection closed. Retrying...","system"),setTimeout(C,3e3)}}s.addEventListener("input",()=>{l&&l.readyState===WebSocket.OPEN&&l.send(JSON.stringify({type:"typing"})),clearTimeout(m),m=setTimeout(()=>{l&&l.readyState===WebSocket.OPEN&&l.send(JSON.stringify({type:"stop_typing"}))},1500)}),o.addEventListener("click",()=>{const e=s.value.trim();e&&(y("You",e,"user"),fetch(r+"/webchat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:c,channel:"webchat",text:e})}).then(e=>console.log("[chatbot] POST /webchat response:",e.status)),s.value="")}),s.addEventListener("keypress",e=>{"Enter"===e.key&&o.click()}),t.addEventListener("click",()=>{n.style.display="flex"}),C()});
