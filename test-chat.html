<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Test Chat (Followups)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat-box { width: 350px; border: 1px solid #ccc; border-radius: 8px;
                display: flex; flex-direction: column; height: 460px; }
    #messages { flex: 1; overflow-y: auto; padding: 8px; border-bottom: 1px solid #ddd; }
    #typingIndicator { display: none; padding: 4px; font-style: italic; color: gray; }
    #input-box { display: flex; gap: 4px; padding: 8px; }
    #msgInput { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    #sendBtn { padding: 6px 12px; }
    .system { color: #888; font-style: italic; margin: 4px 0; }
    .user { color: blue; margin: 4px 0; }
    .staff { color: green; margin: 4px 0; }
    .form-row { margin: 6px 0; display: flex; flex-direction: column; }
    .form-row input, .form-row textarea { padding:6px; border:1px solid #ccc; border-radius:4px; }
    #followupForm { display:none; padding:8px; border-top:1px solid #ddd; }
    #followupForm button { margin-top:6px; padding:6px 10px; }
  </style>
</head>
<body>
  <h2>Visitor Test Chat (Followups)</h2>
  <div id="chat-box">
    <div id="messages"></div>
    <div id="typingIndicator">Admin is typing <span id="typingDots">.</span></div>

    <div id="followupForm">
      <div class="form-row">
        <label for="fuName">Name</label>
        <input id="fuName" type="text" placeholder="Your name" />
      </div>
      <div class="form-row">
        <label for="fuContact">Email or Phone</label>
        <input id="fuContact" type="text" placeholder="you@example.com or +15551234567" />
      </div>
      <div class="form-row">
        <label for="fuMsg">Message</label>
        <textarea id="fuMsg" rows="3" placeholder="Type your message"></textarea>
      </div>
      <button id="fuSubmit">Send</button>
    </div>

    <div id="input-box">
      <input id="msgInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingIndicator = document.getElementById("typingIndicator");
    const typingDots = document.getElementById("typingDots");
    const fuForm = document.getElementById("followupForm");
    const fuName = document.getElementById("fuName");
    const fuContact = document.getElementById("fuContact");
    const fuMsg = document.getElementById("fuMsg");
    const fuSubmit = document.getElementById("fuSubmit");

    const BASE_URL = "http://127.0.0.1:8000";

    let userId = localStorage.getItem("dwc_user_id");
    if (!userId) { userId = "visitor-" + Math.floor(Math.random() * 10000); localStorage.setItem("dwc_user_id", userId); }

    let ws;
    let typingTimeout;
    let typingTimer = null;
    let followupMode = false; // when true, disable /webchat sends

    function appendMessage(sender, text, type = "system") {
      const div = document.createElement("div");
      div.className = type;
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping(show) {
      if (!typingIndicator || !typingDots) return;
      if (show) {
        typingIndicator.style.display = "block";
        let n = 1;
        if (typingTimer) clearInterval(typingTimer);
        typingTimer = setInterval(() => {
          n = (n % 3) + 1;
          typingDots.textContent = ".".repeat(n);
        }, 500);
        setTimeout(() => showTyping(false), 3000);
      } else {
        typingIndicator.style.display = "none";
        if (typingTimer) clearInterval(typingTimer);
        typingDots.textContent = ".";
      }
    }

    function connectWS() {
      const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://127.0.0.1:8000/ws/${userId}`;
      console.log("[visitor] connecting to", wsUrl);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => appendMessage("System", "Connected to chat.", "system");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("[visitor] WS message received:", data);

        if (data.type === "typing") { showTyping(true); return; }
        if (data.type === "stop_typing") { showTyping(false); return; }

        // Detect final escalation prompt -> enable followup form
        if ((data.sender === "system") && data.text && data.text.toLowerCase().includes("leave your message and contact info")) {
          followupMode = true;
          fuForm.style.display = "block";
          appendMessage("System", "Please provide your name, contact, and message below.", "system");
          return;
        }

        appendMessage(data.sender || "system", data.text || "", data.sender || "system");
      };

      ws.onclose = () => {
        appendMessage("System", "Connection closed. Retrying...", "system");
        setTimeout(connectWS, 3000);
      };
    }

    // Typing indicators
    msgInput.addEventListener("input", () => {
      if (followupMode) return;
      if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: "typing" })); }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: "stop_typing" })); }
      }, 1500);
    });

    // Send normal message (disabled once followupMode is true)
    sendBtn.addEventListener("click", () => {
      if (followupMode) { appendMessage("System", "Please complete the follow-up form.", "system"); return; }
      const text = msgInput.value.trim();
      if (!text) return;
      appendMessage("You", text, "user");
      fetch(`${BASE_URL}/webchat`, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, channel: "webchat", text })
      }).then((res) => console.log("[visitor] POST /webchat response:", res.status));
      msgInput.value = "";
    });

    // Follow-up submit
    fuSubmit.addEventListener("click", () => {
      const name = fuName.value.trim();
      const contact = fuContact.value.trim();
      const message = fuMsg.value.trim();
      if (!name || !contact || !message) {
        appendMessage("System", "Please fill in all fields.", "system");
        return;
      }
      fetch(`${BASE_URL}/followup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, channel: "webchat", name, contact, message })
      }).then(async (res) => {
        if (res.ok) {
          appendMessage("System", "Thank you â€” your message has been received.", "system");
          fuForm.style.display = "none";
          followupMode = false; // no need to send more
        } else {
          appendMessage("System", "Sorry, there was a problem sending your follow-up.", "system");
        }
      }).catch(() => appendMessage("System", "Network error sending follow-up.", "system"));
    });

    msgInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendBtn.click(); });

    connectWS();
  </script>
</body>
</html>
