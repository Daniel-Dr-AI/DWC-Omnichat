<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Test Chat (Typing Dots)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat-box { width: 350px; border: 1px solid #ccc; border-radius: 8px;
                display: flex; flex-direction: column; height: 400px; }
    #messages { flex: 1; overflow-y: auto; padding: 8px; border-bottom: 1px solid #ddd; }
    #typingIndicator { display: none; padding: 4px; font-style: italic; color: gray; }
    #input-box { display: flex; gap: 4px; padding: 8px; }
    #msgInput { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
    #sendBtn { padding: 6px 12px; }
    .system { color: #888; font-style: italic; }
    .user { color: blue; }
    .staff { color: green; }
  </style>
</head>
<body>
  <h2>Visitor Test Chat (Typing Dots)</h2>
  <div id="chat-box">
    <div id="messages"></div>

    <!-- âœ… Typing indicator in HTML (not JS!) -->
    <div id="typingIndicator">Admin is typing<span id="typingDots">.</span></div>

    <div id="input-box">
      <input id="msgInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    const typingIndicator = document.getElementById("typingIndicator");
    const typingDots = document.getElementById("typingDots");

    const BASE_URL = "http://127.0.0.1:8000";

    let userId = localStorage.getItem("dwc_user_id");
    if (!userId) {
      userId = "visitor-" + Math.floor(Math.random() * 10000);
      localStorage.setItem("dwc_user_id", userId);
    }

    let ws;
    let typingTimeout;
    let typingTimer = null;

    function appendMessage(sender, text, type = "system") {
      const div = document.createElement("div");
      div.className = type;
      div.innerHTML = `<strong>${sender}:</strong> ${text}`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTyping(show) {
      if (!typingIndicator || !typingDots) return;

      if (show) {
        typingIndicator.style.display = "block";
        let n = 1;
        if (typingTimer) clearInterval(typingTimer);
        typingTimer = setInterval(() => {
          n = (n % 3) + 1;
          typingDots.textContent = ".".repeat(n);
        }, 500);
        // Auto-hide failsafe after 3s
        setTimeout(() => showTyping(false), 3000);
      } else {
        typingIndicator.style.display = "none";
        if (typingTimer) clearInterval(typingTimer);
        typingDots.textContent = ".";
      }
    }

    function connectWS() {
      const wsUrl = `${location.protocol === "https:" ? "wss" : "ws"}://127.0.0.1:8000/ws/${userId}`;
      console.log("[visitor] connecting to", wsUrl);
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        appendMessage("System", "Connected to chat.", "system");
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("[visitor] WS message received:", data);

        if (data.type === "typing") {
          showTyping(true);
          return;
        }

        if (data.type === "stop_typing") {
          showTyping(false);
          return;
        }

        appendMessage(data.sender || "system", data.text || "", data.sender || "system");
      };

      ws.onclose = () => {
        appendMessage("System", "Connection closed. Retrying...", "system");
        setTimeout(connectWS, 3000);
      };
    }

    // Send typing indicators
    msgInput.addEventListener("input", () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "typing" }));
      }
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "stop_typing" }));
        }
      }, 1500);
    });

    // Send message
    sendBtn.addEventListener("click", () => {
      const text = msgInput.value.trim();
      if (!text) return;

      appendMessage("You", text, "user");

      fetch(`${BASE_URL}/webchat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, channel: "webchat", text }),
      }).then((res) =>
        console.log("[visitor] POST /webchat response:", res.status)
      );

      msgInput.value = "";
    });

    msgInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    connectWS();
  </script>
</body>
</html>
