document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("div");e.innerHTML='\n    <div id="chat-toggle">💬</div>\n    <div id="chat-box" style="display:none; flex-direction:column;">\n      <div id="messages" style="flex:1; overflow-y:auto; padding:8px;"></div>\n\n      \x3c!-- ✅ Typing indicator --\x3e\n      <div id="typingIndicator" style="display:none; padding:4px; font-style:italic; color:gray;">\n        Staff is typing<span id="typingDots">.</span>\n      </div>\n\n      <div id="input-box" style="display:flex; gap:4px; padding:8px;">\n        <input id="msgInput" type="text" placeholder="Type a message..." style="flex:1;" />\n        <button id="sendBtn">Send</button>\n      </div>\n    </div>\n  ',document.body.appendChild(e);const t=document.getElementById("chat-toggle"),n=document.getElementById("chat-box"),s=document.getElementById("msgInput"),o=document.getElementById("sendBtn"),d=document.getElementById("messages"),i=document.getElementById("typingIndicator"),a=document.getElementById("typingDots"),l=window.DWC_CHAT_BACKEND||"https://dwc-omnichat.onrender.com";let c,r,y=localStorage.getItem("dwc_user_id");y||(y="visitor-"+Math.floor(1e4*Math.random()),localStorage.setItem("dwc_user_id",y));let p=null,m=null;function g(e,t,n="system"){const s=document.createElement("div");s.className=n,s.innerHTML=`<strong>${e}:</strong> ${t}`,d.appendChild(s),d.scrollTop=d.scrollHeight}function u(e){if(i&&a)if(e){i.style.display="block";let e=1;p&&clearInterval(p),p=setInterval(()=>{e=e%3+1,a.textContent=".".repeat(e)},500),m&&clearTimeout(m),m=setTimeout(()=>u(!1),3e3)}else i.style.display="none",p&&clearInterval(p),m&&clearTimeout(m),a.textContent="."}s.addEventListener("input",()=>{c&&c.readyState===WebSocket.OPEN&&c.send(JSON.stringify({type:"typing"})),clearTimeout(r),r=setTimeout(()=>{c&&c.readyState===WebSocket.OPEN&&c.send(JSON.stringify({type:"stop_typing"}))},1500)}),o.addEventListener("click",()=>{const e=s.value.trim();e&&(g("You",e,"user"),fetch(`${l}/webchat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:y,channel:"webchat",text:e})}).then(e=>console.log("[chatbot] POST /webchat response:",e.status)),s.value="")}),s.addEventListener("keypress",e=>{"Enter"===e.key&&o.click()}),t.addEventListener("click",()=>{n.style.display="none"===n.style.display?"flex":"none"}),function e(){const t=l.replace("https","wss")+`/ws/${y}`;c=new WebSocket(t),c.onopen=()=>g("System","Connected to chat.","system"),c.onmessage=e=>{try{const t=JSON.parse(e.data);if(console.log("[chatbot] WS message received:",t),"typing"===t.type)return void u(!0);if("stop_typing"===t.type)return void u(!1);g(t.sender||"system",t.text||"",t.sender||"system")}catch{g("System","⚠️ Invalid server message","system")}},c.onclose=()=>{g("System","Connection closed. Retrying...","system"),setTimeout(e,3e3)}}()});