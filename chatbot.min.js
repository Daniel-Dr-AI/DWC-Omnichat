document.addEventListener("DOMContentLoaded",function(){const e=document.createElement("div");e.innerHTML='<div id="chat-toggle">💬</div><div id="chat-box" style="display:none; flex-direction:column;"><div id="messages" style="flex:1; overflow-y:auto; padding:8px;"></div><div id="input-box" style="display:flex; gap:4px; padding:8px;"><input id="msgInput" type="text" placeholder="Type a message..." style="flex:1;" /><button id="sendBtn">Send</button></div></div>',document.body.appendChild(e);const t=document.getElementById("chat-toggle"),n=document.getElementById("chat-box"),s=document.getElementById("msgInput"),o=document.getElementById("sendBtn"),a=document.getElementById("messages"),r="https://dwc-omnichat.onrender.com";let c=localStorage.getItem("dwc_user_id");c||(c="visitor-"+Math.floor(1e4*Math.random()),localStorage.setItem("dwc_user_id",c));let d;function i(e,t,n="system"){const s=document.createElement("div");s.className=n,s.innerHTML=`<strong>${e}:</strong> ${t}`,a.appendChild(s),a.scrollTop=a.scrollHeight}function l(){const e=r.replace("https","wss")+`/ws/${c}`;(d=new WebSocket(e)).onopen=()=>i("System","Connected to chat.","system"),d.onmessage=e=>{try{const t=JSON.parse(e.data);i(t.sender||"Bot",t.text,"bot")}catch{ i("System","⚠️ Invalid server message","system")}},d.onclose=()=>{i("System","Connection closed. Retrying...","system"),d=null,setTimeout(l,3e3)}}t.addEventListener("click",()=>{n.style.display="none"===n.style.display?"flex":"none",d||l()}),o.addEventListener("click",async()=>{const e=s.value.trim();if(!e)return;i("You",e,"user"),s.value="";try{await fetch(`${r}/webchat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:c,channel:"webchat",text:e})})}catch(e){i("System","Error sending message.","system")}}),s.addEventListener("keypress",e=>{"Enter"===e.key&&o.click()})});
